# Управление настройками пользователей и авторизацией в CLI `pr`

## 1. Обзор

Данный документ описывает, как CLI `pr` будет управлять пользовательскими настройками, обеспечивая их сохранение между сессиями и поддержку как анонимных, так и авторизованных пользователей. На начальном этапе настройки хранятся в файлах конфигурации на файловой системе.

## 2. Структура файлов и каталогов

Для хранения конфигураций и данных используется следующая структура:

```
~/.practiceraptor.yaml             # Глобальная конфигурация CLI
~/.config/practiceraptor/
├── profiles/
│   ├── _default.yaml              # Профиль анонимного пользователя
│   ├── alexei.yaml                # Профиль пользователя "Alexei"
│   └── ...
├── data/                          # Локальные данные CLI (drafts, logs, cache)
│   └── ...
└── session.token                  # Файл сессии (имя активного пользователя)
```

### 2.1. Глобальная конфигурация CLI (`~/.practiceraptor.yaml`)

Содержит настройки самого CLI и указывает на расположение других конфигурационных файлов.

```yaml
# ~/.practiceraptor.yaml
cli:
  preferred_editor: "vim"
  editor_args: []
  theme: "default"
  data_dir: "~/.config/practiceraptor/data"
  log_level: "INFO"
  auto_save_drafts: true

default_username: "_default"
config_dir: "~/.config/practiceraptor"
session_token_file: "session.token"
```

### 2.2. Файлы профилей пользователей (`~/.config/practiceraptor/profiles/*.yaml`)

Хранят настройки, специфичные для каждого пользователя.

```yaml
# ~/.config/practiceraptor/profiles/<username>.yaml
user_defaults:
  default_language: "python3"
  interface_language: "en"
  task_filters:
    difficulty: "all"
    tags: []
    status: "all"

# Опционально: Переопределения настроек CLI для пользователя.
cli_overrides:
  theme: "dark"  # Пример: Пользователь 'alexei' предпочитает темную тему.
```

### 2.3. Файл информации о сессии (`~/.config/practiceraptor/session.token`)

Указывает имя текущего активного пользователя. Отсутствие файла означает использование анонимного пользователя.

## 3. Цепочка запуска CLI и загрузки конфигурации

При запуске CLI `pr` выполняет следующие шаги:

1.  **Старт приложения:** Пользователь вводит `pr`.
2.  **Загрузка глобальной конфигурации CLI:**
    *   Ищется `~/.practiceraptor.yaml`. Если файл не существует, он создается со значениями по умолчанию.
    *   Загружаются настройки `cli`, `default_username`, `config_dir`, `session_token_file`.
3.  **Определение активного пользователя:**
    *   Проверяется `session.token` (в каталоге `config_dir`).
    *   Если токен существует и содержит имя пользователя, этот пользователь становится активным.
    *   В противном случае используется `default_username` из глобальной конфигурации.
4.  **Загрузка профиля пользователя:**
    *   Путь к файлу профиля формируется на основе `config_dir` и имени активного пользователя (например, `~/.config/practiceraptor/profiles/<active_username>.yaml`).
    *   Если файл профиля существует, он загружается (извлекаются `user_defaults` и `cli_overrides`).
    *   Если файл профиля не существует, он создается с дефолтными `user_defaults` и пустой `cli_overrides`.
5.  **Слияние конфигураций:**
    *   Финальная конфигурация сессии формируется путем слияния:
        *   Глобальные настройки CLI.
        *   Настройки пользователя (`user_defaults` и `cli_overrides`). `cli_overrides` имеют приоритет над глобальными CLI настройками.
        *   Параметры из командной строки (наивысший приоритет).
6.  **Инициализация REPL:**
    *   Приложение переходит в режим REPL. Приглашение может отображать активного пользователя (например, `pr:alexei>`).

## 4. Интеграция с командой `user`

Команды группы `user` управляют авторизацией и настройками профилей.

### 4.1. Авторизация

*   **`pr user login <username>`**:
    *   Аутентифицирует пользователя (проверяет существование профиля или вызывает mock-сервис).
    *   При успехе: записывает `<username>` в `session.token`, перезагружает конфигурацию для нового пользователя.
    *   При неудаче: выводит сообщение об ошибке.

*   **`pr user logout`**:
    *   Удаляет файл `session.token`.
    *   При следующем запуске CLI вернется к использованию `default_username`.

### 4.2. Управление настройками

*   **`pr user settings view`**:
    *   Отображает `user_defaults` из текущего активного профиля пользователя.

*   **`pr user settings set <key> <value>`**:
    *   Обновляет параметр `<key>` в `user_defaults` текущего профиля.
    *   Изменения сохраняются в соответствующий файл профиля.

### 4.3. Управление профилями (дополнительно)

*   **`pr user profile show`**:
    *   Отображает имя активного пользователя и путь к его файлу профиля.

*   **`pr user profile list`**:
    *   Выводит список доступных файлов профилей пользователей (исключая `_default.yaml`).

## 5. Будущие шаги

*   **База данных:** В дальнейшем, вся информация из файлов профилей (`user_defaults`, `cli_overrides`) и файла сессии (`session.token`) будет храниться в централизованной базе данных. Глобальная конфигурация CLI (`~/.practiceraptor.yaml`) может остаться файлом.
